---
title: "BigDots"
author: "Daniel Newman"
date: "12 June 2016"
output:
  html_document:
    fig_width: 8
    keep_md: yes
  word_document: default
---

```{r Load and Pre-Process the single trial Data, echo=FALSE, include=FALSE}

####Which computer/directory is this being run on?
location<-"Monash"
# location<-"GersLaptop"

if (location=="Monash") {
    setwd(("C:/GitHub/big_dots/Analyses Scripts_R"))
} else if (location=="GersLaptop") {
    setwd(("C:/Users/loughnge/Documents/GitHub/big_dots/Analyses Scripts_R"))
} else setwd(("~"))



### Install/load required packages
#List of R packages required for this analysis:
required_packages <- c("psych", "ggplot2", "dplyr", "tidyr", "stringr", "lubridate", "readxl","knitr",
                       "readr", "rmarkdown", "png", "lme4", "ez", "multcomp")
#Install required_packages:
new.packages <- required_packages[!(required_packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)
#Load required_packages:
lapply(required_packages, require, character.only = TRUE)




###### Import single trial data:
if (location=="Monash") {
data <- read.csv("C:/GitHub/big_dots/master_matrix_R_BigDots.csv", header=FALSE)
} else if (location=="GersLaptop") {
data <- read.csv("C:/Users/Dan/Documents/GitHub/big_dots/master_matrix_R_BigDots.csv", header=FALSE)
} else setwd(("~"))
#Import IDs:
if (location=="Monash") {
ID <- read.table("C:/GitHub/big_dots/ID_vector_BigDots.csv", quote="\"")
} else if (location=="GersLaptop") {
ID <- read.table("C:/Users/Dan/Documents/GitHub/big_dots/ID_vector_BigDots.csv", quote="\"")
} else setwd(("~"))

data$ID<-data[,1]
#Replace the participant numbers with IDs:
data[,1]<-ID[,1]
#Remove the seperate ID vector now it has been included into data dataframe
rm(ID)
drops <- c("ID")
data<-data[,!(names(data) %in% drops)]


###Read in Participant Demographics (note for Sex 1=male)
Demographics<-read_excel("Participant_Demographics.xlsx") %>% #then calculate Age at testing date:
    mutate(Age_as_period=as.period(interval(Date_Of_Birth, Date_Of_Testing), units="years")) %>%
    mutate(Sex = ifelse(Sex==1, "Male", "Female"))
#Calculate Age in numeric format
Demographics$Age<-as.numeric(difftime(as.Date(Demographics$Date_Of_Testing), as.Date(Demographics$Date_Of_Birth), units = "days")/365)
summary(Demographics$Age)


#########################################################################################################################

data<- data %>% #Rename data columns:
    rename(., 
            ID=V1,
            TotalTrialNumber=V2,
            Trial=V3,
            ITI=V4,
            Hemifield=V5,
            Accuracy=V6,
            Art_neg500_0=V7,
            Art_neg100_100PR=V8,
            Art_neg500_100PR=V9,
            Art_neg100_1000=V10,
            FixBreak_neg500_0=V11,
            FixBreak_neg100_100PR=V12,
            FixBreak_neg500_100PR=V13,
            FixBreak_neg100_1000=V14,
            RT=V15,
           PreAlphaPower=V16,
           PreAlphaPowerLH=V17,
           PreAlphaPowerRH=V18,
           PreAlphaAsym=V19,
           PostAlphaPowerLH=V20,
           PostAlphaPowerRH=V21,
           Location=V22) %>% #next make the required columns into factors:
    mutate_each_(funs(factor), c("ITI", "Hemifield", "Accuracy")) %>% #next re-class required vectors into Logicals:
    mutate_at(vars(starts_with("Art_")), funs(as.logical)) %>% 
    mutate_at(vars(starts_with("FixBreak_")), funs(as.logical)) %>% #next use the ! negation operator to reverse of a TRUE/FALSE vectors: 
    mutate_if(purrr::is_logical, funs(!.)) %>% #next Rename factor Levels:
    mutate(Hemifield = ifelse(Hemifield==1, "Left", "Right"), 
           Accuracy= ifelse(Accuracy==1, "Hit", ifelse(Accuracy==2, "WrongButton", "Miss")),
            Location = ifelse(Location==1, "TCD", "Monash"))


Demographics <-Demographics[Demographics$ID %in% data$ID, ]   

###############Data Cleaning For Single Trial Data######################

#Check number of Trials for each participant by running the function 'length', 
#on "data$RT" for each DAT1_3UTR, broken down by ID + Light
num_trials1 <- data %>% group_by(ID) %>% summarise( Trials = length(RT))
summary(num_trials1$Trials)


##################Accuracy ##########################
Accuracy_checker <- data %>% group_by(ID) %>% 
                    summarise(Hits  = sum(Accuracy=="Hit"),
                               Misses = sum(Accuracy=="Miss" | Accuracy=="WrongButton")) %>%
                    mutate(Total=Hits+Misses,
                           Accuracy_overall= (Hits/Total)*100) 
summary(Accuracy_checker$Accuracy_overall)

##Add in overall accuracy 
data <- merge(data, Accuracy_checker, by.x = "ID", by.y = "ID")

######Test for effect of Hemifield on Accuracy:
# Accuracy_checker <- data %>% group_by(ID, Hemifield) %>% 
#                     summarise(Hits  = sum(Accuracy=="Hit"),
#                                Misses = sum(Accuracy=="Miss" | Accuracy=="WrongButton")) %>%
#                     mutate(Total=Hits+Misses,
#                            Accuracy_overall= (Hits/Total)*100) 
# log <- capture.output({
#    Hemifield_Perm <- ezPerm(data = data.frame(Accuracy_checker)
#                           , dv = .(Accuracy_overall)
#                           , wid = .(ID)
#                           , within = .(Hemifield)
#                           , perms = 1000);
#  })
# print("Factorial Permutation test for the effect of Hemifield Accuracy:")
# print(Hemifield_Perm);
##########################################################################


###Remove trials where:
#RT longer than 1000ms (i.e. after target finished)
#RT faster than 100ms (i.e. too fast must be false alarm) or RT=0 (i.e. they did not respond)
#Kick out trials with fixation breaks:
data<-filter(data, RT<1500 & RT>150 & !FixBreak_neg100_100PR)


############################################ Log transform:
##############################################################################################
data$log_RT<-log(data$RT) #log
#####Z-score each participant's log_RT data ####
data$IDbyITIbyHemifield<-interaction(data$ID, data$ITI, data$Hemifield)
#calculate mean and sd 
m <- tapply(data$log_RT,data$IDbyITIbyHemifield,mean, na.rm = T)
s <- tapply(data$log_RT,data$IDbyITIbyHemifield,sd, na.rm = T)
#calculate log_RT.Z and save it inside data.frame
data$log_RT.Z <- (data$log_RT-m[data$IDbyITIbyHemifield])/s[data$IDbyITIbyHemifield]
#Remove trials where absolute log_RT.Z>3 (i.e. remove outlier RTs)
data<-data[!abs(data$log_RT.Z)>3,]


#plot again after outlier removal:
ggplot(data, aes(RT))  + geom_histogram(aes(y=..count..), colour="black", fill="white") 
ggplot(data, aes(log_RT))  + geom_histogram(aes(y=..count..), colour="black", fill="white") 


#Calculate the number of trials each participant has left after fixation break trials are kicked out:
num_trials2 <- data %>% group_by(ID) %>% summarise( Trials = length(RT))
summary(num_trials2$Trials)

#Calculate alpha desynchronisation by subtracting Pre-target Alpha from post target alpha
data$AlphaDesyncRH<-(data$PreAlphaPowerRH)-(data$PostAlphaPowerRH)
data$AlphaDesyncLH<-data$PreAlphaPowerLH-data$PostAlphaPowerLH
# Make PostAlpha contralateral (PostAlpha_c) and -Ipsilateral (PostAlpha_i) variables:
A<-data$Hemifield=="Left"
#Absolute post target alpha
data$PostAlpha_c[A]<-data$PostAlphaPowerRH[A]
data$PostAlpha_c[!A]<-data$PostAlphaPowerLH[!A]
data$PostAlpha_i[!A]<-data$PostAlphaPowerRH[!A]
data$PostAlpha_i[A]<-data$PostAlphaPowerLH[A]
#Post target Alpha desynchronisation 
data$AlphaDesync_c[A]<-data$AlphaDesyncRH[A]
data$AlphaDesync_c[!A]<-data$AlphaDesyncLH[!A]
data$AlphaDesync_i[!A]<-data$AlphaDesyncRH[!A]
data$AlphaDesync_i[A]<-data$AlphaDesyncLH[A]

rm(A)



####Import participant_level_matrix with ERP measures
if (location=="Monash") {
participant_level <- read.csv("C:/GitHub/big_dots/participant_level_matrix.csv", header=FALSE)
} else if (location=="DansLaptop") {
participant_level <- read.csv("C:/Users/Dan/Documents/GitHub/big_dots/participant_level_matrix.csv", header=FALSE)
} else setwd(("~"))
#Import IDs:
if (location=="Monash") {
ID <- read.table("C:/GitHub/big_dots/IDs.csv", quote="\"")
} else if (location=="DansLaptop") {
ID <- read.csv("C:/Users/Dan/Documents/GitHub/big_dots/IDs.csv", header=F)
} else setwd(("~"))
ID<-plyr::rename(ID,c("V1"="ID"))
participant_level$ID<-ID$ID
rm(ID)

participant_level<- participant_level %>% #Rename data columns:
                            rename(., 
                                    N2c_LeftTarget=V1,
                                    N2c_RightTarget=V2,
                                    N2i_LeftTarget=V3,
                                    N2i_RightTarget=V4,
                                    N2c_latency_LeftTarget=V5,
                                    N2c_latency_RightTarget=V6,
                                    N2i_latency_LeftTarget=V7,
                                    N2i_latency_RightTarget=V8,
                                    CPPonset_LeftTarget=V9,
                                    CPPonset_RightTarget=V10,
                                    CPPslope_LeftTarget=V11,
                                    CPPslope_RightTarget=V12,
                                    Location=V13 ) %>% ##next calculate the ERP asymmetry measures:
                            mutate(., 
                                  N2c_Asym = (N2c_LeftTarget-N2c_RightTarget)/(N2c_LeftTarget+N2c_RightTarget), 
                                  N2i_Asym = (N2i_LeftTarget-N2i_RightTarget)/(N2i_LeftTarget+N2i_RightTarget),
                                  N2c_latency_Asym = (N2c_latency_LeftTarget-N2c_latency_RightTarget)/(N2c_latency_LeftTarget+N2c_latency_RightTarget), 
                                  N2i_latency_Asym =(N2i_latency_LeftTarget-N2i_latency_RightTarget)/(N2i_latency_LeftTarget+N2i_latency_RightTarget),
                                  CPPonset_Asym = (CPPonset_LeftTarget-CPPonset_RightTarget)/(CPPonset_LeftTarget+CPPonset_RightTarget),
                                  CPPslope_Asym = (CPPslope_LeftTarget-CPPslope_RightTarget)/(CPPslope_LeftTarget+CPPslope_RightTarget),
                                  Location = ifelse(Location==1, "TCD", "Monash")
                                  )

####################################################################################
#Collapse each participant's PreAlpha trials to participant level
PreAlphaAsym_collapsed<- data %>% 
            filter(!Art_neg500_0, !FixBreak_neg500_0) %>%
            group_by(ID) %>%
            summarise(PreAlphaAsym=mean(PreAlphaAsym))
#Merge it in with the ERP measures
participant_level<-merge(participant_level, PreAlphaAsym_collapsed, by.x = "ID", by.y = "ID") 

#Collapse each participant's PostAlpha trials to participant level
PostAlphaAsym_collapsed<- data %>% 
            filter(!Art_neg500_0, !FixBreak_neg500_0, PostAlpha_c!=0, PostAlpha_i!=0) %>%
            mutate(PostAlphaAsym=(PostAlpha_c-PostAlpha_i)/(PostAlpha_c+PostAlpha_i)) %>% #contra - ipsi asym
            group_by(ID) %>%
            summarise(PostAlphaAsym=mean(PostAlphaAsym))
#Merge it in with the ERP measures
participant_level<-merge(participant_level, PostAlphaAsym_collapsed, by.x = "ID", by.y = "ID") 


#Collapse each participant's Post-target AlphaDesync single trials to participant level
AlphaDesync_c_collapsed<- data %>% 
            filter(!Art_neg500_100PR, !FixBreak_neg500_100PR, AlphaDesync_c!=0) %>%
            group_by(ID, Hemifield) %>%
            summarise(AlphaDesync_c=mean(AlphaDesync_c)) %>% #next bring Target-Hemifield up into wide format:
            spread(Hemifield, AlphaDesync_c) %>% #next rename
            rename(AlphaDesync_c_LeftTarget=Left, AlphaDesync_c_RightTarget=Right) %>% # next Calculate RT asymmetry:
            mutate(AlphaDesync_c_Asym=(AlphaDesync_c_LeftTarget-AlphaDesync_c_RightTarget)/(AlphaDesync_c_LeftTarget+AlphaDesync_c_RightTarget)) 
#Merge it in with the ERP measures
participant_level<-merge(participant_level, AlphaDesync_c_collapsed, by.x = "ID", by.y = "ID") 

AlphaDesync_i_collapsed<- data %>% 
            filter(!Art_neg500_100PR, !FixBreak_neg500_100PR, AlphaDesync_i!=0) %>%
            group_by(ID, Hemifield) %>%
            summarise(AlphaDesync_i=mean(AlphaDesync_i)) %>% #next bring Target-Hemifield up into wide format:
            spread(Hemifield, AlphaDesync_i) %>% #next rename
            rename(AlphaDesync_i_LeftTarget=Left, AlphaDesync_i_RightTarget=Right) %>% # next Calculate RT asymmetry:
            mutate(AlphaDesync_i_Asym=(AlphaDesync_i_LeftTarget-AlphaDesync_i_RightTarget)/(AlphaDesync_i_LeftTarget+AlphaDesync_i_RightTarget)) 
#Merge it in with the ERP measures
participant_level<-merge(participant_level, AlphaDesync_i_collapsed, by.x = "ID", by.y = "ID") 


#Collapse each participant's RT single trials to participant level
RT_collapsed<- data %>% 
            group_by(ID, Hemifield) %>%
            summarise(RT=mean(RT)) %>% #next bring Target-Hemifield up into wide format:
            spread(Hemifield, RT) %>% #next rename
            rename(RT_Left=Left, RT_Right=Right) %>% # next Calculate RT asymmetry:
            mutate(RT_Asym=(RT_Left-RT_Right)/(RT_Left+RT_Right)) 
#Merge it in with the ERP measures
participant_level<-merge(participant_level, RT_collapsed, by.x = "ID", by.y = "ID") 


#Transform it to long format
participant_level_long<-participant_level %>%
                    gather(measure_type, data, -ID, -Location) %>%
                    na.omit()
####Find outliers in the Participant level data (abs z-score >3)####
#################################################################
#Calculate Z scores inside measure_type type TO REMOVE OUTLIERS
#Z-score each participant's data inside measure_type ####
#calculate mean and sd 
m <- tapply(participant_level_long$data,participant_level_long$measure_type,mean, na.rm = T)
s <- tapply(participant_level_long$data,participant_level_long$measure_type,sd, na.rm = T)
 
#calculate data.Z and save it inside participant_level_long
participant_level_long$data.Z <- (participant_level_long$data-m[participant_level_long$measure_type])/s[participant_level_long$measure_type]
#Remove trials where absolute data.Z>3 (i.e. remove outlier RTs)
# participant_level_long<-participant_level_long[!abs(participant_level_long$data.Z)>3,]

# Shift extream outliers back to +/- 3 standard deviations from the mean
participant_level_long$data[participant_level_long$data.Z>3]<-m[participant_level_long$measure_type][participant_level_long$data.Z>3] + 3*s[participant_level_long$measure_type][participant_level_long$data.Z>3]
participant_level_long$data[participant_level_long$data.Z<(-3)]<-m[participant_level_long$measure_type][participant_level_long$data.Z<(-3)] - 3*s[participant_level_long$measure_type][participant_level_long$data.Z<(-3)]


#calculate data.Z again and save it inside participant_level_long
participant_level_long$data.Z <- (participant_level_long$data-m[participant_level_long$measure_type])/s[participant_level_long$measure_type]


#Plot density plots again after outlier removal
ggplot(participant_level_long, aes(data))  + geom_density() + facet_wrap(~ measure_type, scales="free")

#change measure_type to factor class
participant_level_long$measure_type<-as.factor(participant_level_long$measure_type)

#Put it back into long format so I can use lapply to do t-test on columns 
participant_level<-participant_level_long %>% select(., -data.Z)  %>% 
                    spread(measure_type, data) 

#Merge in the Demographics
participant_level<-merge(participant_level, Demographics, by.x = "ID", by.y = "ID") 
####################################################################################
```


```{r, Beta}

###### Import trial sample level data (500Hz):
if (location=="Monash") {
data_Resp_locked_Beta <- read.csv("C:/GitHub/big_dots/master_matrix_R_Resp_locked_beta.csv", header=FALSE)
ID <- read.table("C:/GitHub/big_dots/ID_vector_Resp_locked_beta.csv", quote="\"")
} else if (location=="DansLaptop") {
data_Stim_locked_Beta <- read.csv("C:/Users/Dan/Documents/GitHub/big_dots/master_matrix_R_Resp_locked_beta.csv", header=FALSE)
ID <- read.table("C:/Users/Dan/Documents/GitHub/big_dots/ID_vector_Resp_locked_beta.csv", quote="\"")
} else setwd(("~"))

data_Resp_locked_Beta$ID<-data_Resp_locked_Beta[,1]
#Replace the participant numbers with IDs:
data_Resp_locked_Beta[,1]<-ID[,1]
#Remove the seperate ID vector now it has been included into data dataframe
rm(ID)
drops <- c("ID")
data_Resp_locked_Beta<-data_Resp_locked_Beta[,!(names(data_Resp_locked_Beta) %in% drops)]

#Merge with the RT, Accuracy, Hemifield data 
data_Resp_locked_Beta<- data_Resp_locked_Beta %>% #Rename data columns:
    rename(., 
           ID=V1,
           TotalTrialNumber=V2,
           Trial=V3,
           Time=V4,
           Resp_locked_Beta=V5) %>%
    merge(., data, by = c("ID", "Trial", "TotalTrialNumber")) 

#Filter out artifacts
data_Resp_locked_Beta<- data_Resp_locked_Beta %>% filter(!Art_neg100_100PR)

#Plot response locked 
detach("package:dplyr", unload=TRUE) #Detach dplyr as functions below use plyr
source("summarySE.R") 
source("summarySEwithin.R") #function to calculate Std.Er of mean
source("normDataWithin.R")
plotdata_Resp_locked_Beta <- summarySEwithin(data_Resp_locked_Beta, measurevar="Resp_locked_Beta", withinvars=c("Time", "Hemifield"), idvar="ID")
plotdata_Resp_locked_Beta$Time<-as.numeric(as.character(plotdata_Resp_locked_Beta$Time))
summary(plotdata_Resp_locked_Beta$Time)
lapply(required_packages, require, character.only = TRUE) # re-load all librarys no that I'm finished with dlyr

#Resp_locked_Beta Group on same plot
ggplot(plotdata_Resp_locked_Beta, aes(x=Time, y=Resp_locked_Beta, color=Hemifield,fill=Hemifield)) + 
    geom_line(size=1.4) + geom_ribbon(aes(ymin=Resp_locked_Beta-ci, ymax=Resp_locked_Beta+ci), alpha = 0.3, colour=NA) + 
        geom_hline(yintercept=0, alpha = 0.5) + geom_vline(xintercept=0, alpha = 0.5) +   
    coord_cartesian(ylim = c(0.6, 0.75),  xlim = c(-400, 100)) +
    xlab("Time") + ylab("Beta Power (uV)") +
    theme(axis.title.x = element_text(face="bold", size=12),
          axis.text.x  = element_text(face="bold", angle=0,  size=12)) +
    theme(axis.title.y = element_text(face="bold", size=12),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=12)) +
    theme(legend.title = element_text(size=11, face="bold")) +
    theme(legend.text = element_text(size = 11, face = "bold")) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
          panel.background = element_blank(), axis.line = element_line(colour = "black"))





```


#Run the Shapiro-Wilk test of normality on the RT, CPPonset, N2c, etc. measures as a function of hemifield
```{r, echo=FALSE, warning=FALSE}
options(scipen=99)
Normality_tests <-participant_level %>% 
                    select(contains("Left"), contains("Right"))  %>% 
                    gather() %>% 
                    group_by(key) %>%
                    do(ShapiroWilk_p_value= shapiro.test(.$value)[2],
                       Anderson_Darling_p_value = nortest::ad.test(.$value)[2], 
                       CramerVonMises_p_value = nortest::cvm.test(.$value)[2],
                       Shapiro_Francia_p_value = nortest::sf.test(.$value)[2],
                       Kolmogorov_Smirnov_p_value= nortest::lillie.test(.$value)[2]) %>% 
                    mutate(ShapiroWilk_p_value= unlist(ShapiroWilk_p_value),
                       Anderson_Darling_p_value = unlist(Anderson_Darling_p_value), 
                       CramerVonMises_p_value = unlist(CramerVonMises_p_value),
                       Shapiro_Francia_p_value = unlist(Shapiro_Francia_p_value),
                       Kolmogorov_Smirnov_p_value = unlist(Kolmogorov_Smirnov_p_value)) %>% 
                    mutate(average_p_value=(ShapiroWilk_p_value + 
                                                Anderson_Darling_p_value + 
                                                CramerVonMises_p_value + 
                                                Shapiro_Francia_p_value + 
                                                Kolmogorov_Smirnov_p_value)/5) %>% arrange(average_p_value)
print(data.frame(Normality_tests))
print(data.frame(Normality_tests$key, Normality_tests$average_p_value))
```

#Test the effect of Target Hemifield on RT, CPPonset, N2c, etc. using Factorial Permutation test
```{r, echo=FALSE, warning=FALSE}
###################################################################
Perm_data<- participant_level %>% 
    select(ID, RT_Left, RT_Right) %>%
    na.omit() %>%
    gather(Hemifield, dv, -ID) 

log <- capture.output({
   Hemifield_Perm <- ezPerm(data = Perm_data
                          , dv = .(dv)
                          , wid = .(ID)
                          , within = .(Hemifield)
                          , perms = 1000);
 })
print("Factorial Permutation test for the effect of Hemifield on RT:")
print(Hemifield_Perm);


ggplot(Perm_data, aes(Hemifield, dv, colour = Hemifield))  + 
          geom_violin(alpha=0.5) + geom_boxplot() +  theme_bw () + geom_point()


ggplot(Perm_data, aes(Hemifield, dv, colour = Hemifield, group = ID))  + 
          geom_violin() +  theme_bw () + geom_point() + geom_line(colour="black")


###################################################################
Perm_data<- participant_level %>% 
    select(ID, CPPslope_LeftTarget, CPPslope_RightTarget) %>%
    na.omit() %>%
    gather(Hemifield, dv, -ID) 

log <- capture.output({
   Hemifield_Perm <- ezPerm(data = Perm_data
                          , dv = .(dv)
                          , wid = .(ID)
                          , within = .(Hemifield)
                          , perms = 1000);
 })
print("Factorial Permutation test for the effect of Hemifield on CPP Slope:")
print(Hemifield_Perm);

###################################################################
Perm_data<- participant_level %>% 
    select(ID, CPPonset_LeftTarget, CPPonset_RightTarget) %>%
    na.omit() %>%
    gather(Hemifield, dv, -ID) 

log <- capture.output({
   Hemifield_Perm <- ezPerm(data = Perm_data
                          , dv = .(dv)
                          , wid = .(ID)
                          , within = .(Hemifield)
                          , perms = 1000);
 })
print("Factorial Permutation test for the effect of Hemifield on CPP Onset:")
print(Hemifield_Perm);

ggplot(Perm_data, aes(Hemifield, dv, colour = Hemifield))  + 
          geom_violin() + geom_boxplot() +  theme_bw () + geom_point() + geom_line()

ggplot(Perm_data, aes(Hemifield, dv, colour = Hemifield, group = ID))  + 
          geom_violin() +  theme_bw () + geom_point() + geom_line(colour="black")

###################################################################
Perm_data<- participant_level %>% 
    select(ID, N2i_latency_LeftTarget, N2i_latency_RightTarget) %>%
    na.omit() %>%
    gather(Hemifield, dv, -ID) 

log <- capture.output({
   Hemifield_Perm <- ezPerm(data = Perm_data
                          , dv = .(dv)
                          , wid = .(ID)
                          , within = .(Hemifield)
                          , perms = 1000);
 })
print("Factorial Permutation test for the effect of Hemifield on N2i_latency:")
print(Hemifield_Perm);

###################################################################
Perm_data<- participant_level %>% 
    select(ID, N2i_LeftTarget, N2i_RightTarget) %>%
    na.omit() %>%
    gather(Hemifield, dv, -ID) 

log <- capture.output({
   Hemifield_Perm <- ezPerm(data = Perm_data
                          , dv = .(dv)
                          , wid = .(ID)
                          , within = .(Hemifield)
                          , perms = 1000);
 })
print("Factorial Permutation test for the effect of Hemifield on N2i Amplitude:")
print(Hemifield_Perm);


###################################################################
Perm_data<- participant_level %>% 
    select(ID, N2c_latency_LeftTarget, N2c_latency_RightTarget) %>%
    na.omit() %>%
    gather(Hemifield, dv, -ID) 

log <- capture.output({
   Hemifield_Perm <- ezPerm(data = Perm_data
                          , dv = .(dv)
                          , wid = .(ID)
                          , within = .(Hemifield)
                          , perms = 1000);
 })
print("Factorial Permutation test for the effect of Hemifield on N2c_latency:")
print(Hemifield_Perm);

###################################################################
Perm_data<- participant_level %>% 
    select(ID, N2c_LeftTarget, N2c_RightTarget) %>%
    na.omit() %>%
    gather(Hemifield, dv, -ID) 

log <- capture.output({
   Hemifield_Perm <- ezPerm(data = Perm_data
                          , dv = .(dv)
                          , wid = .(ID)
                          , within = .(Hemifield)
                          , perms = 1000);
 })
print("Factorial Permutation test for the effect of Hemifield on N2c Amplitude:")
print(Hemifield_Perm);


###################################################################
Perm_data<- participant_level %>% 
    select(ID, AlphaDesync_c_LeftTarget, AlphaDesync_c_RightTarget) %>%
    na.omit() %>%
    gather(Hemifield, dv, -ID) 

log <- capture.output({
   Hemifield_Perm <- ezPerm(data = Perm_data
                          , dv = .(dv)
                          , wid = .(ID)
                          , within = .(Hemifield)
                          , perms = 1000);
 })
print("Factorial Permutation test for the effect of Hemifield on AlphaDesync_c:")
print(Hemifield_Perm);


###################################################################
###################################################################
Perm_data<- participant_level %>% 
    select(ID, AlphaDesync_c_LeftTarget, AlphaDesync_c_RightTarget) %>%
    na.omit() %>%
    gather(Hemifield, dv, -ID) 

log <- capture.output({
   Hemifield_Perm <- ezPerm(data = Perm_data
                          , dv = .(dv)
                          , wid = .(ID)
                          , within = .(Hemifield)
                          , perms = 1000);
 })
print("Factorial Permutation test for the effect of Hemifield on AlphaDesync_i:")
print(Hemifield_Perm);




```


#Test the effect of Target Hemifield on RT, CPPonset, N2c, etc. using repeated measures ANOVA
```{r, echo=FALSE, warning=FALSE}
###################################################################
ANOVA_data<- participant_level %>% 
    select(ID, RT_Left, RT_Right) %>%
    na.omit() %>%
    gather(Hemifield, dv, -ID) 
    # %>% mutate(dv=log(dv))


   Hemifield_ANOVA <- ezANOVA(data = ANOVA_data
                        , dv = .(dv)
                        , wid = .(ID)
                        , within = .(Hemifield)
                        , within_covariates = NULL
                        , between = NULL
                        , between_covariates = NULL
                        , observed = NULL
                        , type = 3)
print("Repeated Measures ANOVA  for the effect of Hemifield on RT:")
print(Hemifield_ANOVA);


ggplot(ANOVA_data, aes(Hemifield, dv, colour = Hemifield))  + 
          geom_violin() + geom_boxplot(alpha=0.1) +  theme_bw () + geom_point()

ggplot(ANOVA_data, aes(Hemifield, dv, colour = Hemifield, group = ID))  + 
            geom_point() + geom_line(colour="black")

###################################################################
ANOVA_data<- participant_level %>% 
    select(ID, CPPslope_LeftTarget, CPPslope_RightTarget) %>%
    na.omit() %>%
    gather(Hemifield, dv, -ID) 


   Hemifield_ANOVA <- ezANOVA(data = ANOVA_data
                          , dv = .(dv)
                          , wid = .(ID)
                          , within = .(Hemifield)
                        , within_covariates = NULL
                        , between = NULL
                        , between_covariates = NULL
                        , observed = NULL
                        , type = 3);
print("Repeated Measures ANOVA  for the effect of Hemifield on CPP Slope:")
print(Hemifield_ANOVA);

###################################################################
ANOVA_data<- participant_level %>% 
    select(ID, CPPonset_LeftTarget, CPPonset_RightTarget) %>%
    na.omit() %>%
    gather(Hemifield, dv, -ID) 


   Hemifield_ANOVA <- ezANOVA(data = ANOVA_data
                          , dv = .(dv)
                          , wid = .(ID)
                          , within = .(Hemifield)
                        , within_covariates = NULL
                        , between = NULL
                        , between_covariates = NULL
                        , observed = NULL
                        , type = 3);
print("Repeated Measures ANOVA  for the effect of Hemifield on CPP Onset:")
print(Hemifield_ANOVA);

ggplot(ANOVA_data, aes(Hemifield, dv, colour = Hemifield))  + 
          geom_violin() + geom_boxplot(alpha=0.1) +  theme_bw () + geom_point() + geom_line()

ggplot(ANOVA_data, aes(Hemifield, dv, colour = Hemifield, group = ID))  + 
            geom_point() + geom_line(colour="black")

###################################################################
ANOVA_data<- participant_level %>% 
    select(ID, N2i_latency_LeftTarget, N2i_latency_RightTarget) %>%
    na.omit() %>%
    gather(Hemifield, dv, -ID) 


   Hemifield_ANOVA <- ezANOVA(data = ANOVA_data
                          , dv = .(dv)
                          , wid = .(ID)
                          , within = .(Hemifield)
                        , within_covariates = NULL
                        , between = NULL
                        , between_covariates = NULL
                        , observed = NULL
                        , type = 3);
print("Repeated Measures ANOVA  for the effect of Hemifield on N2i_latency:")
print(Hemifield_ANOVA);

###################################################################
ANOVA_data<- participant_level %>% 
    select(ID, N2i_LeftTarget, N2i_RightTarget) %>%
    na.omit() %>%
    gather(Hemifield, dv, -ID) 


   Hemifield_ANOVA <- ezANOVA(data = ANOVA_data
                          , dv = .(dv)
                          , wid = .(ID)
                          , within = .(Hemifield)
                        , within_covariates = NULL
                        , between = NULL
                        , between_covariates = NULL
                        , observed = NULL
                        , type = 3);
print("Repeated Measures ANOVA  for the effect of Hemifield on N2i Amplitude:")
print(Hemifield_ANOVA);


###################################################################
ANOVA_data<- participant_level %>% 
    select(ID, N2c_latency_LeftTarget, N2c_latency_RightTarget) %>%
    na.omit() %>%
    gather(Hemifield, dv, -ID) 


   Hemifield_ANOVA <- ezANOVA(data = ANOVA_data
                          , dv = .(dv)
                          , wid = .(ID)
                          , within = .(Hemifield)
                        , within_covariates = NULL
                        , between = NULL
                        , between_covariates = NULL
                        , observed = NULL
                        , type = 3);
print("Repeated Measures ANOVA  for the effect of Hemifield on N2c_latency:")
print(Hemifield_ANOVA);

###################################################################
ANOVA_data<- participant_level %>% 
    select(ID, N2c_LeftTarget, N2c_RightTarget) %>%
    na.omit() %>%
    gather(Hemifield, dv, -ID) 


   Hemifield_ANOVA <- ezANOVA(data = ANOVA_data
                          , dv = .(dv)
                          , wid = .(ID)
                          , within = .(Hemifield)
                        , within_covariates = NULL
                        , between = NULL
                        , between_covariates = NULL
                        , observed = NULL
                        , type = 3);
print("Repeated Measures ANOVA  for the effect of Hemifield on N2c Amplitude:")
print(Hemifield_ANOVA);


###################################################################
ANOVA_data<- participant_level %>% 
    select(ID, AlphaDesync_i_LeftTarget, AlphaDesync_i_RightTarget) %>%
    na.omit() %>%
    gather(Hemifield, dv, -ID) 


   Hemifield_ANOVA <- ezANOVA(data = ANOVA_data
                          , dv = .(dv)
                          , wid = .(ID)
                          , within = .(Hemifield)
                        , within_covariates = NULL
                        , between = NULL
                        , between_covariates = NULL
                        , observed = NULL
                        , type = 3);
print("Repeated Measures ANOVA  for the effect of Hemifield on AlphaDesync_i:")
print(Hemifield_ANOVA);


###################################################################
ANOVA_data<- participant_level %>% 
    select(ID, AlphaDesync_c_LeftTarget, AlphaDesync_c_RightTarget) %>%
    na.omit() %>%
    gather(Hemifield, dv, -ID) 


   Hemifield_ANOVA <- ezANOVA(data = ANOVA_data
                          , dv = .(dv)
                          , wid = .(ID)
                          , within = .(Hemifield)
                        , within_covariates = NULL
                        , between = NULL
                        , between_covariates = NULL
                        , observed = NULL
                        , type = 3);
print("Repeated Measures ANOVA  for the effect of Hemifield on AlphaDesync_c:")
print(Hemifield_ANOVA);

```




#test correlation between all of the Asymmetry measures (i.e. RT, N2, CPP, alpha, asymmetry) 
```{r, echo=FALSE, warning=FALSE}
Normality_tests <-participant_level %>% 
                    select(contains("Asym"))  %>% 
                    gather() %>% 
                    group_by(key) %>%
                    do(ShapiroWilk_p_value= shapiro.test(.$value)[2],
                       Anderson_Darling_p_value = nortest::ad.test(.$value)[2], 
                       CramerVonMises_p_value = nortest::cvm.test(.$value)[2],
                       Shapiro_Francia_p_value = nortest::sf.test(.$value)[2],
                       Kolmogorov_Smirnov_p_value= nortest::lillie.test(.$value)[2]) %>% 
                    mutate(ShapiroWilk_p_value= unlist(ShapiroWilk_p_value),
                       Anderson_Darling_p_value = unlist(Anderson_Darling_p_value), 
                       CramerVonMises_p_value = unlist(CramerVonMises_p_value),
                       Shapiro_Francia_p_value = unlist(Shapiro_Francia_p_value),
                       Kolmogorov_Smirnov_p_value = unlist(Kolmogorov_Smirnov_p_value)) %>% 
                    mutate(average_p_value=(ShapiroWilk_p_value + 
                                                Anderson_Darling_p_value + 
                                                CramerVonMises_p_value + 
                                                Shapiro_Francia_p_value + 
                                                Kolmogorov_Smirnov_p_value)/5) %>% arrange(average_p_value)
print(data.frame(Normality_tests))


#Get the required data i.e. ID, and all the asymmeyry index measures
data_for_cor<-participant_level %>% 
                select(contains("Asym"))

##look at r-values, p-palues, and CIs. can use pearson for parametric or spearman for nonparmetric
cor_pram_list<-corr.test(data_for_cor, use = "pairwise", method="pearson", adjust="none")
print(cor_pram_list, short=F)

#######################################
##Plot p-value matrix using ggplot:
png("P_values less than 05 uncorrected.png",  width = 10*600, height = 10*600, units = "px", res = 600)
p_data<-reshape2::melt(cor_pram_list$p)
p_data<-plyr::rename(p_data, c("value"="p_value"))
p_data<-dplyr::mutate(p_data, p_value = replace(p_value, p_value>.05, NA)) #only plot uncorected p-values less than .04
####Plot:
qplot(x=Var1, y=Var2, data=p_data, fill=p_value, geom="tile")+
    theme(axis.title.x = element_text(face="bold", size=9),
          axis.text.x  = element_text(face="bold", angle=-90,  size=9)) +
    theme(axis.title.y = element_text(face="bold", size=9),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=9))
dev.off()

qplot(x=Var1, y=Var2, data=p_data, fill=p_value, geom="tile")+
    theme(axis.title.x = element_text(face="bold", size=9),
          axis.text.x  = element_text(face="bold", angle=-90,  size=9)) +
    theme(axis.title.y = element_text(face="bold", size=9),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=9))
#######################################



#Make correlation matrix for corPlot()
cor_matrix<-cor(as.matrix(data_for_cor), use="na.or.complete", method="pearson")

#Save the corPlot() as a .png image
png("Correlation betweem RT_Asymmetry & SLF_Asymmetry.png",  width = 10*600, height = 10*600, units = "px", res = 600)
corPlot(cor_matrix, numbers=T, main="Correlation betweem RT_Asymmetry & SLF_Asymmetry",  show.legend=F, upper=T,  cex = 1)
dev.off()
corPlot(cor_matrix, numbers=T, main="Correlation betweem RT_Asymmetry & SLF_Asymmetry",  show.legend=F, upper=T,  cex = 1)


p1<-ggplot(data_for_cor, aes(x=RT_Asym, y=N2c_Asym)) +
    geom_point(shape=1) +    # Use hollow circles
    geom_smooth(method=lm,   # Add linear regression line
                se=FALSE)    # Don't add shaded confidence region

p2<-ggplot(data_for_cor, aes(x=RT_Asym, y=N2c_latency_Asym)) +
    geom_point(shape=1) +    # Use hollow circles
    geom_smooth(method=lm,   # Add linear regression line
                se=FALSE)    # Don't add shaded confidence region
				
				

p3<-ggplot(data_for_cor, aes(x=RT_Asym, y=N2c_Asym)) +
    geom_point(shape=1) +    # Use hollow circles
    geom_smooth(method=lm,   # Add linear regression line
                se=FALSE)    # Don't add shaded confidence region
				
				
p4<-ggplot(data_for_cor, aes(x=RT_Asym, y=N2i_Asym)) +
    geom_point(shape=1) +    # Use hollow circles
    geom_smooth(method=lm,   # Add linear regression line
                se=FALSE)    # Don't add shaded confidence region
				
				

p5<-ggplot(data_for_cor, aes(x=RT_Asym, y=N2c_latency_Asym)) +
    geom_point(shape=1) +    # Use hollow circles
    geom_smooth(method=lm,   # Add linear regression line
                se=FALSE)    # Don't add shaded confidence region
				
				
p6<-ggplot(data_for_cor, aes(x=RT_Asym, y=CPPonset_Asym)) +
    geom_point(shape=1) +    # Use hollow circles
    geom_smooth(method=lm,   # Add linear regression line
                se=FALSE)    # Don't add shaded confidence region
				
				
p7<-ggplot(data_for_cor, aes(x=RT_Asym, y=CPPslope_Asym)) +
    geom_point(shape=1) +    # Use hollow circles
    geom_smooth(method=lm,   # Add linear regression line
                se=FALSE)    # Don't add shaded confidence region

p8<-ggplot(data_for_cor, aes(x=N2c_Asym, y=CPPslope_Asym)) +
    geom_point(shape=1) +    # Use hollow circles
    geom_smooth(method=lm,   # Add linear regression line
                se=FALSE)    # Don't add shaded confidence region
				
				
p9<-ggplot(data_for_cor, aes(x=N2c_latency_Asym, y=CPPonset_Asym)) +
    geom_point(shape=1) +    # Use hollow circles
    geom_smooth(method=lm,   # Add linear regression line
                se=FALSE)    # Don't add shaded confidence region



ggplot(data_for_cor, aes(x=RT_Asym, y=CPPonset_Asym)) +
    geom_point(shape=1) +    # Use hollow circles
    geom_smooth(method=lm,   # Add linear regression line
                se=FALSE)    # Don't add shaded confidence region

ggplot(data_for_cor, aes(x=RT_Asym, y=PreAlphaAsym)) +
    geom_point(shape=1) +    # Use hollow circles
    geom_smooth(method=lm,   # Add linear regression line
                se=FALSE)    # Don't add shaded confidence region

ggplot(data_for_cor, aes(x=CPPonset_Asym, y=PreAlphaAsym)) +
    geom_point(shape=1) +    # Use hollow circles
    geom_smooth(method=lm,   # Add linear regression line
                se=FALSE)    # Don't add shaded confidence region

ggplot(data_for_cor, aes(x=CPPslope_Asym, y=AlphaDesync_i_Asym)) +
    geom_point(shape=1) +    # Use hollow circles
    geom_smooth(method=lm,   # Add linear regression line
                se=FALSE)    # Don't add shaded confidence region

ggplot(data_for_cor, aes(x=CPPonset_Asym, y=AlphaDesync_c_Asym)) +
    geom_point(shape=1) +    # Use hollow circles
    geom_smooth(method=lm,   # Add linear regression line
                se=FALSE)    # Don't add shaded confidence region

ggplot(data_for_cor, aes(x=N2c_Asym, y=AlphaDesync_c_Asym)) +
    geom_point(shape=1) +    # Use hollow circles
    geom_smooth(method=lm,   # Add linear regression line
                se=FALSE)    # Don't add shaded confidence region

ggplot(data_for_cor, aes(x=CPPonset_Asym, y=AlphaDesync_c_Asym)) +
    geom_point(shape=1) +    # Use hollow circles
    geom_smooth(method=lm,   # Add linear regression line
                se=FALSE)    # Don't add shaded confidence region


ggplot(data_for_cor, aes(x=CPPonset_Asym, y=CPPslope_Asym)) +
    geom_point(shape=1) +    # Use hollow circles
    geom_smooth(method=lm,   # Add linear regression line
                se=FALSE)    # Don't add shaded confidence region


ggplot(data_for_cor, aes(x=RT_Asym, y=CPPslope_Asym)) +
    geom_point(shape=1) +    # Use hollow circles
    geom_smooth(method=lm,   # Add linear regression line
                se=FALSE)    # Don't add shaded confidence region
				

png("Some Scatter Plots.png",  width = 10*300, height = 10*300, units = "px", res = 600)				
source("multiplot.R")				
multiplot(p1,p2,p3,p4,p5,p6,p7,p8,p9, cols=3)
dev.off()
multiplot(p1,p2,p3,p4,p5,p6,p7,p8,p9, cols=3)


# plot(data_for_cor[,c(1:10)])


#Make histograms of all asymmetry_indexes
hist_data<-tidyr::gather(data_for_cor, measure, asymmetry_index, na.rm = T, convert = T, factor_key = T)
png("histograms of all asymmetry_indexes.png",  width = 10*600, height = 10*600, units = "px", res = 600)
ggplot(hist_data, aes(asymmetry_index))  + geom_histogram() + facet_wrap(~ measure, scales="free")
dev.off()
ggplot(hist_data, aes(asymmetry_index))  + geom_histogram() + facet_wrap(~ measure, scales="free")

```

#Look at multiple regression to predice RT_Asym 
```{r, echo=FALSE, warning=FALSE}
### Fitting the Model

# Multiple Linear Regression Example 
fit <- lm(RT_Asym~ PreAlphaAsym + N2c_Asym + CPPslope_Asym + CPPonset_Asym, data=participant_level)
fit <- lm(RT_Asym~ PreAlphaAsym + N2c_Asym + N2i_Asym + N2c_latency_Asym + N2i_latency_Asym + AlphaDesync_c_Asym + AlphaDesync_i_Asym + CPPslope_Asym + CPPonset_Asym, data=participant_level)
fit <- lm(RT_Asym~ Location + Sex + Age + PreAlphaAsym + N2c_latency_Asym + CPPslope_Asym + CPPonset_Asym, data=participant_level)

coefficients(fit) # model coefficients
confint(fit, level=0.95) # CIs for model parameters 
# fitted(fit) # predicted values
# residuals(fit) # residuals
anova(fit) # anova table 
# vcov(fit) # covariance matrix for model parameters 
# influence(fit) # regression diagnostics
# diagnostic plots 
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page 
plot(fit)



# Robust Multiple Linear Regression Example 
library(MASS)
fit <- rlm(RT_Asym~ PreAlphaAsym + N2c_Asym + CPPslope_Asym + CPPonset_Asym, data=participant_level)
fit <- rlm(RT_Asym~ Location + Sex + Age + PreAlphaAsym + N2c_latency_Asym + CPPslope_Asym + CPPonset_Asym, data=participant_level)

Anova(fit, type="III") # show results



```












#Look at the effect of Hemifield on RT on a single trial level using linear mixed model

```{r, echo=FALSE, warning=FALSE}
data$Hemifield<-as.factor(data$Hemifield)

RT_random_effects_only<-lmer(log(RT) ~ 1 + (Hemifield | ID) +(1|ITI) + (1|Trial), data = data, REML=FALSE, na.action = na.omit)
RT_Hemifield<-update(RT_random_effects_only, .~. + Hemifield)
RT_TOT<-update(RT_Hemifield, .~. + Trial)
RT_Hemifield_by_TOT<-update(RT_TOT, .~. + Hemifield:Trial)
anova(RT_random_effects_only, RT_Hemifield, RT_Hemifield_by_TOT)

RT_PreAlphaPower<-update(RT_Hemifield_by_TOT, .~. + PreAlphaPower)
anova(RT_Hemifield_by_TOT, RT_PreAlphaPower)


# 
# #Look at a boxplot of log(RT)
# ggplot(data, aes(Hemifield, log(RT), colour = Hemifield))  + 
#     geom_boxplot() + coord_flip() + theme_bw ()


#Plot the effect of Hemifield*Time-on-task
ggplot(data, aes(x=data$Trial, y=data$RT,fill=Hemifield,colour=Hemifield)) +
     # stat_smooth(method="glm",level = 0.95,size=1) + # Add a glm smoothed fit curve with 95% confidence region around the three light conditions
    geom_smooth() +
    scale_fill_manual(name="Target\nHemifield",  breaks=c("Left", "Right"), labels=c(" Left", " Right"), guide = guide_legend(reverse=TRUE), values=c("#999999", "black")) +
    scale_colour_manual(name="Target\nHemifield",  breaks=c("Left", "Right"), labels=c(" Left", " Right"), guide = guide_legend(reverse=TRUE), values=c("black", "black")) +
    ylab("RT (ms)") +  xlab("Time On Task (trials)") + coord_cartesian(ylim = c(500, 700))+
    theme(axis.title.x = element_text(face="bold", size=14),
          axis.text.x  = element_text(face="bold", angle=0,  size=12)) +
    theme(axis.title.y = element_text(face="bold", size=14),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=12)) +
    theme(legend.title = element_text(size=14, face="bold")) +
    theme(legend.text = element_text(size = 12, face = "bold")) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
    panel.background = element_blank(), axis.line = element_line(colour = "black")) 

##Check the plot of the model parameters matches with this^ plot of the raw data 
# require(effects)
# plot(allEffects(RT_Hemifield_by_TOT), multiline=T)


```

**So this ^ shows that participants tended to react faster to left hemifield targets, but this leftward advangate decreased over time**


